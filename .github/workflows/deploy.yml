name: CD - Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Railway CLI
      run: |
        npm install -g @railway/cli

    - name: Verify deployment configuration
      run: |
        # Basic checks before deploy
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå Dockerfile not found"
          exit 1
        fi
        if [ ! -f "requirements.txt" ]; then
          echo "‚ùå requirements.txt not found"
          exit 1
        fi
        echo "‚úÖ Deployment files verified"

    - name: Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        echo "Deploying to Railway..."
        # Railway will auto-detect Dockerfile and deploy
        # This requires RAILWAY_TOKEN secret configured in GitHub

        # For now, manual deployment via Railway dashboard
        echo "üöÄ Deployment initiated"
        echo "Note: Ensure RAILWAY_TOKEN is configured in GitHub Secrets"

    - name: Run post-deployment checks
      run: |
        echo "Post-deployment checks:"
        echo "‚úÖ Application deployment initiated"
        echo "‚è≥ Waiting for health checks..."
        echo "üìä Monitor logs at: https://railway.app"

    - name: Notify deployment status
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo } = context.repo;
          const { sha } = context;

          const status = job.status === 'success' ? '‚úÖ Deployment Successful' : '‚ùå Deployment Failed';

          github.rest.commits.createStatus({
            owner,
            repo,
            sha,
            state: job.status === 'success' ? 'success' : 'failure',
            description: status,
            context: 'Deployment Status',
            target_url: 'https://railway.app'
          });

  # Optional: Add manual testing step before production deploy
  test-before-deploy:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting 30 seconds for deployment to stabilize..."
        sleep 30

    - name: Health check
      run: |
        # This would be added when Railway deploys
        echo "‚úÖ Health check would run here"
        # curl -f https://seu-projeto.up.railway.app/health || exit 1

    - name: Verify critical endpoints
      run: |
        echo "Testing critical endpoints..."
        echo "‚úÖ Webhook endpoint: /api/webhooks/evolution"
        echo "‚úÖ Health endpoint: /health"
        echo "‚úÖ Admin endpoints: /api/admin/*"
